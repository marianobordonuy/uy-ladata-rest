<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin ‚Äî Validaci√≥n de reservas ¬∑ uyu.exchange</title>
    <meta name="description" content="Panel para validar reservas (c√≥digos) generadas en uyu.exchange." />

    <!-- Open Graph -->
    <meta property="og:title" content="Admin ‚Äî Validaci√≥n de reservas ¬∑ uyu.exchange" />
    <meta property="og:description" content="Panel para validar reservas (c√≥digos) generadas en uyu.exchange." />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="es_UY" />
    <meta property="og:url" content="https://uyu.exchange/admin.html" />
    <meta property="og:image" content="/og-image.png" />

    <!-- TailwindCSS + paleta del sitio -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50:'#f1f8f5',100:'#dcefe6',200:'#c1e1d1',300:'#99ccb3',400:'#6fb896',
                500:'#4aa87d',600:'#2f9467',700:'#247a56',800:'#1f6247',900:'#1a523c'
              }
            }
          }
        }
      }
    </script>

    <link rel="icon" href="/favicon.ico" />
  </head>
  <body class="bg-gradient-to-b from-white to-brand-50 text-slate-900 antialiased">

    <!-- Header -->
    <header class="sticky top-0 z-40 backdrop-blur bg-white/70 border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <a href="/" class="flex items-center gap-2 font-semibold text-slate-900">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-brand-600 text-white">U</span>
            <span class="hidden sm:inline">uyu.exchange</span>
          </a>
          <nav class="hidden md:flex items-center gap-6 text-sm">
            <a href="/" class="hover:text-brand-700">Inicio</a>
            <a href="/nosotros.html" class="hover:text-brand-700">Nosotros</a>
            <a href="/admin.html" class="inline-flex items-center rounded-xl bg-slate-900 px-4 py-2 font-medium text-white hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-900">Admin</a>
          </nav>
          <button id="menuBtn" class="md:hidden inline-flex items-center justify-center rounded-lg p-2 hover:bg-slate-100" aria-label="Abrir men√∫">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M3.75 5.25a.75.75 0 0 1 .75-.75h15a.75.75 0 0 1 0 1.5h-15a.75.75 0 0 1-.75-.75Zm0 6a.75.75 0 0 1 .75-.75h15a.75.75 0 0 1 0 1.5h-15a.75.75 0 0 1-.75-.75Zm0 6a.75.75 0 0 1 .75-.75h15a.75.75 0 0 1 0 1.5h-15a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd"/></svg>
          </button>
        </div>
      </div>
      <div id="mobileMenu" class="md:hidden hidden border-t border-slate-200 bg-white">
        <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col gap-3 text-sm">
          <a href="/" class="hover:text-brand-700">Inicio</a>
          <a href="/nosotros.html" class="hover:text-brand-700">Nosotros</a>
          <a href="/admin.html" class="inline-flex items-center rounded-xl bg-slate-900 px-4 py-2 font-medium text-white w-max hover:bg-slate-800">Admin</a>
        </div>
      </div>
    </header>

    <!-- Contenido -->
    <main class="py-10 sm:py-14">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl">
          <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-slate-900">Panel de Validaci√≥n</h1>
          <p class="mt-3 text-slate-600">Ingres√° un c√≥digo o eleg√≠ una reserva reciente para **abrir la p√°gina de validaci√≥n**.</p>
        </div>

        <!-- App mount -->
        <div id="app" class="mt-8"></div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-t mx-auto border-slate-200 bg-brand-50/40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-xs sm:text-sm text-slate-600 flex flex-col sm:flex-row items-center justify-between gap-2">
        <div>¬© <span id="year"></span> uyu.exchange ‚Äî Hecho en Uruguay üá∫üáæ</div>
        <div class="flex items-center gap-4">
          <a href="/" class="hover:text-brand-700">Inicio</a>
          <a href="/nosotros.html" class="hover:text-brand-700">Nosotros</a>
          <a href="mailto:api@uyu.exchange" class="hover:text-brand-700">Contacto</a>
          <a href="/admin.html" class="hover:text-brand-700 font-medium">üß≠ Admin</a>
          <a href="/admin-operaciones.html" class="hover:text-brand-700 font-medium">üìä Operaciones</a>
        </div>
      </div>
    </footer>

    <!-- Scripts -->
    <script>
      // ========= Shell b√°sico =========
      const $ = (sel, el = document) => el.querySelector(sel);
      document.getElementById('year').textContent = new Date().getFullYear();
      const menuBtn = document.getElementById('menuBtn');
      const mobileMenu = document.getElementById('mobileMenu');
      menuBtn?.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

      // ========= Auth simple (hash) =========
      const app = document.getElementById("app");

      // Mismo hash que tu admin anterior:
      const correctHash = "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9";

      async function sha256(text) {
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
      }

      if (localStorage.getItem("adminLogged") === "true") {
        renderAdminPanel();
      } else {
        renderLogin();
      }

      function renderLogin() {
        app.innerHTML = `
          <section>
            <div class="max-w-sm mx-auto">
              <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm p-6">
                <h2 class="text-xl font-bold text-slate-900 mb-1">üîê Acceso Admin</h2>
                <p class="text-sm text-slate-600 mb-4">Ingres√° la contrase√±a para continuar.</p>
                <label class="block text-sm font-medium text-slate-700 mb-1" for="password">Contrase√±a</label>
                <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full rounded-xl border-slate-300 focus:border-brand-600 focus:ring-brand-600" />
                <button id="loginBtn" class="mt-4 w-full inline-flex items-center justify-center rounded-xl bg-brand-600 px-4 py-2 text-white font-semibold hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-600">Ingresar</button>
                <p id="errorMsg" class="text-red-600 text-sm mt-3 hidden">‚õî Contrase√±a incorrecta</p>
                <div class="mt-4">
                  <a href="/index.html" class="inline-flex items-center justify-center w-full rounded-xl bg-slate-100 px-4 py-2 text-slate-800 hover:bg-slate-200">‚¨ÖÔ∏è Volver al Inicio</a>
                </div>
              </div>
            </div>
          </section>
        `;
        document.getElementById("loginBtn").addEventListener("click", async () => {
          const password = document.getElementById("password").value || "";
          const hash = await sha256(password);
          if (hash === correctHash) {
            localStorage.setItem("adminLogged", "true");
            renderAdminPanel();
          } else {
            document.getElementById("errorMsg").classList.remove("hidden");
          }
        });
      }

      // ========= Panel principal =========
      function renderAdminPanel() {
        app.innerHTML = `
          <section class="space-y-6">
            <!-- Barra superior -->
            <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm p-6">
              <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div>
                  <h2 class="text-2xl font-bold text-slate-900">Validaci√≥n de reservas</h2>
                  <p class="text-sm text-slate-600">Abr√≠ el link de validaci√≥n para confirmar o rechazar la transacci√≥n.</p>
                </div>
                <div class="flex gap-2">
                  <a href="/index.html" class="inline-flex items-center rounded-xl bg-slate-100 px-4 py-2 text-slate-800 hover:bg-slate-200">‚¨ÖÔ∏è Inicio</a>
                  <button id="logoutBtn" class="inline-flex items-center rounded-xl bg-red-600 px-4 py-2 text-white hover:bg-red-700">üîì Cerrar sesi√≥n</button>
                </div>
              </div>
            </div>

            <!-- Validador r√°pido -->
            <div class="rounded-2xl ring-1 ring-slate-200 bg-slate-50 p-6">
              <h3 class="text-lg font-semibold text-slate-900">Validador r√°pido</h3>
              <p class="text-sm text-slate-600 mt-1">Peg√° el c√≥digo de 6 caracteres o escane√° un QR y abr√≠ la p√°gina de validaci√≥n.</p>
              <div class="mt-4 grid grid-cols-1 sm:grid-cols-[1fr_auto] gap-3 max-w-xl">
                <input id="codeInput" type="text" maxlength="6" placeholder="C√≥digo (ej: 7K4X2M)" class="uppercase tracking-wider font-mono text-lg w-full rounded-xl border-slate-300 focus:border-brand-600 focus:ring-brand-600 px-4 py-2" />
                <button id="openBtn" class="inline-flex items-center justify-center rounded-xl bg-brand-600 px-5 py-2.5 text-white font-semibold hover:bg-brand-700">Abrir validar</button>
              </div>
              <p class="text-xs text-slate-500 mt-2">Atajo: Enter para abrir.</p>
            </div>

            <!-- Reservas recientes -->
            <div class="rounded-2xl ring-1 ring-slate-200 bg-white p-6">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <h3 class="text-lg font-semibold text-slate-900">Reservas recientes</h3>
                  <p class="text-sm text-slate-600">√öltimas 20 (si el endpoint est√° disponible).</p>
                </div>
                <button id="reloadBtn" class="inline-flex items-center rounded-xl bg-slate-900 px-4 py-2 text-white hover:bg-slate-800">‚ü≥ Actualizar</button>
              </div>
              <div id="recentContainer" class="mt-4">
                <div class="text-sm text-slate-500">Cargando‚Ä¶</div>
              </div>
            </div>
          </section>
        `;

        // Eventos
        document.getElementById("logoutBtn").addEventListener("click", () => {
          localStorage.removeItem("adminLogged");
          renderLogin();
        });

        const codeInput = document.getElementById("codeInput");
        const openBtn = document.getElementById("openBtn");
        function openValidation() {
          const code = (codeInput.value || "").trim().toUpperCase();
          if (!/^[A-Z0-9]{6}$/.test(code)) {
            alert("Ingres√° un c√≥digo v√°lido de 6 caracteres.");
            return;
          }
          // Abrir la p√°gina de validaci√≥n
          const url = `/validar.html?code=${encodeURIComponent(code)}`;
          window.location.href = url;
        }
        openBtn.addEventListener("click", openValidation);
        codeInput.addEventListener("keydown", (e) => { if (e.key === "Enter") openValidation(); });

        // Cargar reservas recientes
        document.getElementById("reloadBtn").addEventListener("click", loadRecent);
        loadRecent();
      }

      async function loadRecent() {
        const box = document.getElementById("recentContainer");
        if (!box) return;
        box.innerHTML = `<div class="text-sm text-slate-500">Cargando‚Ä¶</div>`;

        try {
          // Ajust√° este endpoint a lo que tengas disponible en tu API:
          // ideal: GET /app/reservas?limit=20
          const res = await fetch(`/app/reservas?limit=20`, { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const items = await res.json();

          if (!Array.isArray(items) || items.length === 0) {
            box.innerHTML = `<div class="text-sm text-slate-500">No hay reservas recientes.</div>`;
            return;
          }

          // Render tabla simple
          const rows = items.map((r) => {
            const exp = r.expiresAt ? new Date(r.expiresAt) : null;
            const vence = exp ? exp.toLocaleString('es-UY') : '‚Äî';
            const estado = r.status || (exp && exp.getTime() < Date.now() ? 'expirada' : 'activa');
            const uyus = typeof r.uyus === 'number' ? r.uyus.toFixed(2) : '‚Äî';
            const usd = typeof r.usdAmount === 'number' ? r.usdAmount.toFixed(2) : '‚Äî';
            const fuente = r.sourceName || r.source || '‚Äî';
            const code = r.code || '‚Äî';
            const link = `/validar.html?code=${encodeURIComponent(code)}`;
            return `
              <tr class="hover:bg-slate-50">
                <td class="px-3 py-2 font-mono text-sm">${code}</td>
                <td class="px-3 py-2 text-sm">${fuente}</td>
                <td class="px-3 py-2 text-sm text-right">${usd}</td>
                <td class="px-3 py-2 text-sm text-right">$ ${uyus}</td>
                <td class="px-3 py-2 text-sm">${vence}</td>
                <td class="px-3 py-2">
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] ring-1
                    ${estado === 'activa' ? 'bg-green-50 text-green-800 ring-green-200' :
                      estado === 'expirada' ? 'bg-slate-50 text-slate-700 ring-slate-200' :
                      'bg-amber-50 text-amber-800 ring-amber-200'}">${estado}</span>
                </td>
                <td class="px-3 py-2 text-right">
                  <a href="${link}" class="inline-flex items-center rounded-xl bg-brand-600 px-3 py-1.5 text-white text-sm font-medium hover:bg-brand-700">Validar</a>
                </td>
              </tr>
            `;
          }).join('');

          box.innerHTML = `
            <div class="overflow-x-auto">
              <table class="min-w-full text-left">
                <thead class="text-xs uppercase tracking-wide text-slate-500">
                  <tr>
                    <th class="px-3 py-2">C√≥digo</th>
                    <th class="px-3 py-2">Fuente</th>
                    <th class="px-3 py-2 text-right">USD</th>
                    <th class="px-3 py-2 text-right">UYU</th>
                    <th class="px-3 py-2">Vence</th>
                    <th class="px-3 py-2">Estado</th>
                    <th class="px-3 py-2 text-right">Acci√≥n</th>
                  </tr>
                </thead>
                <tbody class="text-sm">${rows}</tbody>
              </table>
            </div>
          `;
        } catch (err) {
          console.error(err);
          box.innerHTML = `
            <div class="rounded-xl bg-slate-50 ring-1 ring-slate-200 p-4">
              <div class="text-sm text-slate-600">
                No se pudieron cargar las reservas recientes. Pod√©s validar manualmente arriba con el c√≥digo.
              </div>
            </div>`;
        }
      }
    </script>
  </body>
</html>
