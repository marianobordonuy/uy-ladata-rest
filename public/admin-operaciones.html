<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Operaciones ‚Äî Panel Admin ‚Äî uyu.exchange</title>
  <meta name="description" content="Dashboard de operaciones: reservas pendientes y validadas, y resumen de fees." />
  <link rel="icon" href="/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: {
        brand:{50:'#f1f8f5',100:'#dcefe6',200:'#c1e1d1',300:'#99ccb3',400:'#6fb896',500:'#4aa87d',600:'#2f9467',700:'#247a56',800:'#1f6247',900:'#1a523c'}
      }}}
    };
  </script>
</head>
<body class="bg-gradient-to-b from-white to-brand-50 text-slate-900 antialiased">

  <!-- Header -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/70 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <a href="/" class="flex items-center gap-2 font-semibold text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-brand-600 text-white">U</span>
          <span class="hidden sm:inline">uyu.exchange</span>
        </a>
        <nav class="hidden md:flex items-center gap-6 text-sm">
          <a href="/" class="hover:text-brand-700">Inicio</a>
          <a href="/admin.html" class="hover:text-brand-700">Admin</a>
          <a href="/admin-operaciones.html" class="inline-flex items-center rounded-xl bg-slate-900 px-4 py-2 font-medium text-white hover:bg-slate-800">Operaciones</a>
        </nav>
        <button id="menuBtn" class="md:hidden inline-flex items-center justify-center rounded-lg p-2 hover:bg-slate-100" aria-label="Abrir men√∫">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M3.75 5.25a.75.75 0 0 1 .75-.75h15a.75.75 0 0 1 0 1.5h-15a.75.75 0 0 1-.75-.75Zm0 6a.75.75 0 0 1 .75-.75h15a.75.75 0 0 1 0 1.5h-15a.75.75 0 0 1-.75-.75Zm0 6a.75.75 0 0 1 .75-.75h15a.75.75 0 0 1 0 1.5h-15a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd"/></svg>
        </button>
      </div>
    </div>
    <div id="mobileMenu" class="md:hidden hidden border-t border-slate-200 bg-white">
      <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col gap-3 text-sm">
        <a href="/" class="hover:text-brand-700">Inicio</a>
        <a href="/admin.html" class="hover:text-brand-700">Admin</a>
        <a href="/admin-operaciones.html" class="inline-flex items-center rounded-xl bg-slate-900 px-4 py-2 font-medium text-white w-max hover:bg-slate-800">Operaciones</a>
      </div>
    </div>
  </header>

  <!-- App mount -->
  <main class="py-10 sm:py-14">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div id="app"></div>
    </div>
  </main>

    <!-- Footer -->
    <footer class="border-t mx-auto border-slate-200 bg-brand-50/40">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-xs sm:text-sm text-slate-600 flex flex-col sm:flex-row items-center justify-between gap-2">
        <div>¬© <span id="year"></span> uyu.exchange ‚Äî Hecho en Uruguay üá∫üáæ</div>
        <div class="flex items-center gap-4">
          <a href="/" class="hover:text-brand-700">Inicio</a>
          <a href="/nosotros.html" class="hover:text-brand-700">Nosotros</a>
          <a href="mailto:api@uyu.exchange" class="hover:text-brand-700">Contacto</a>
          <a href="/admin.html" class="hover:text-brand-700 font-medium">üß≠ Admin</a>
          <a href="/admin-operaciones.html" class="hover:text-brand-700 font-medium">üìä Operaciones</a>
        </div>
      </div>
    </footer>

  <script>
    // ===== Shell & helpers b√°sicos =====
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
    document.getElementById('year').textContent = new Date().getFullYear();
    const menuBtn = document.getElementById('menuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    menuBtn?.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

    const API = {
      list: (params='') => fetch('/app/reservas' + params, { cache:'no-store' }).then(r=>r.json()),
      validate: (code, body={}) => fetch('/app/reservas/' + encodeURIComponent(code) + '/validate', {
        method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      }).then(r=>r.json()),
      cancel: (code, body={}) => fetch('/app/reservas/' + encodeURIComponent(code) + '/cancel', {
        method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      }).then(r=>r.json()),
    };

    const fmt = n => new Intl.NumberFormat('es-UY',{minimumFractionDigits:2, maximumFractionDigits:2}).format(Number(n||0));
    const asDate = (v) => v ? new Date(v) : null;

    // ====== Autenticaci√≥n (igual a admin.html) ======
    const app = document.getElementById("app");
    const correctHash = "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9"; // mismo hash
    async function sha256(text) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function renderLogin() {
      app.innerHTML = `
        <section>
          <div class="max-w-sm mx-auto">
            <div class="rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm p-6">
              <h2 class="text-xl font-bold text-slate-900 mb-1">üîê Acceso Operaciones</h2>
              <p class="text-sm text-slate-600 mb-4">Ingres√° la contrase√±a para continuar.</p>
              <label class="block text-sm font-medium text-slate-700 mb-1" for="password">Contrase√±a</label>
              <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full rounded-xl border-slate-300 focus:border-brand-600 focus:ring-brand-600" />
              <button id="loginBtn" class="mt-4 w-full inline-flex items-center justify-center rounded-xl bg-brand-600 px-4 py-2 text-white font-semibold hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-600">Ingresar</button>
              <p id="errorMsg" class="text-red-600 text-sm mt-3 hidden">‚õî Contrase√±a incorrecta</p>
              <div class="mt-4">
                <a href="/index.html" class="inline-flex items-center justify-center w-full rounded-xl bg-slate-100 px-4 py-2 text-slate-800 hover:bg-slate-200">‚¨ÖÔ∏è Volver al Inicio</a>
              </div>
            </div>
          </div>
        </section>
      `;
      document.getElementById("loginBtn").addEventListener("click", async () => {
        const password = document.getElementById("password").value || "";
        const hash = await sha256(password);
        if (hash === correctHash) {
          localStorage.setItem("adminLogged", "true");
          renderPanel();
        } else {
          document.getElementById("errorMsg").classList.remove("hidden");
        }
      });
    }

    if (localStorage.getItem("adminLogged") === "true") {
      renderPanel();
    } else {
      renderLogin();
    }

    // ====== Panel de Operaciones ======
    function renderPanel() {
      app.innerHTML = `
        <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-3">
          <div>
            <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-slate-900">Operaciones</h1>
            <p class="mt-2 text-slate-600">Reservas pendientes y validadas desde <span class="font-mono">data/reservas.json</span>.</p>
          </div>
          <div class="flex gap-2">
            <input id="q" type="search" placeholder="Buscar por c√≥digo o fuente‚Ä¶" class="rounded-xl border-slate-300 focus:border-brand-600 focus:ring-brand-600 px-3 py-2 w-64" />
            <button id="refresh" class="rounded-xl bg-slate-100 px-4 py-2 hover:bg-slate-200">Actualizar</button>
            <button id="logoutBtn" class="rounded-xl bg-red-600 px-4 py-2 text-white hover:bg-red-700">Cerrar sesi√≥n</button>
          </div>
        </div>

        <!-- KPIs de estados -->
        <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 p-4">
            <div class="text-xs text-slate-500">Pendientes</div>
            <div id="kpi-pending" class="text-2xl font-bold">‚Äî</div>
          </div>
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 p-4">
            <div class="text-xs text-slate-500">Validadas (24h)</div>
            <div id="kpi-validated" class="text-2xl font-bold">‚Äî</div>
          </div>
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 p-4">
            <div class="text-xs text-slate-500">Expiradas</div>
            <div id="kpi-expired" class="text-2xl font-bold">‚Äî</div>
          </div>
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 p-4">
            <div class="text-xs text-slate-500">Canceladas</div>
            <div id="kpi-cancelled" class="text-2xl font-bold">‚Äî</div>
          </div>
        </div>

        <!-- KPIs de Fees -->
        <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 p-4">
            <div class="text-xs text-slate-500">Fees ‚Äî Hoy</div>
            <div id="fee-today" class="text-2xl font-bold">‚Äî</div>
            <div class="text-[11px] text-slate-500 mt-1">(USD)</div>
          </div>
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 p-4">
            <div class="text-xs text-slate-500">Fees ‚Äî Ayer</div>
            <div id="fee-yesterday" class="text-2xl font-bold">‚Äî</div>
            <div class="text-[11px] text-slate-500 mt-1">(USD)</div>
          </div>
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 p-4">
            <div class="text-xs text-slate-500">Fees ‚Äî √öltimos 7 d√≠as</div>
            <div id="fee-7d" class="text-2xl font-bold">‚Äî</div>
            <div class="text-[11px] text-slate-500 mt-1">(incluye hoy)</div>
          </div>
          <div class="rounded-2xl bg-white ring-1 ring-slate-200 p-4">
            <div class="text-xs text-slate-500">Fees ‚Äî √öltimos 30 d√≠as</div>
            <div id="fee-30d" class="text-2xl font-bold">‚Äî</div>
            <div class="text-[11px] text-slate-500 mt-1">(incluye hoy)</div>
          </div>
        </div>

        <!-- Listas -->
        <div class="mt-8 grid lg:grid-cols-2 gap-6">
          <!-- Pendientes -->
          <section class="rounded-2xl bg-white ring-1 ring-slate-200 p-4 sm:p-6">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold">Pendientes</h2>
              <span id="lastUpdated" class="text-xs text-slate-500">‚Äî</span>
            </div>
            <div id="list-pending" class="mt-3 divide-y divide-slate-200"></div>
          </section>

          <!-- Validadas -->
          <section class="rounded-2xl bg-white ring-1 ring-slate-200 p-4 sm:p-6">
            <h2 class="text-lg font-semibold">Validadas</h2>
            <div id="list-validated" class="mt-3 divide-y divide-slate-200"></div>
          </section>
        </div>
      `;

      // Eventos
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('adminLogged');
        renderLogin();
      });
      document.getElementById('refresh').addEventListener('click', loadAll);
      const qInput = document.getElementById('q');
      qInput.addEventListener('input', () => { clearTimeout(window.__qT); window.__qT = setTimeout(loadAll, 250); });

      loadAll();
      setInterval(loadAll, 10000); // auto-refresh suave
    }

    // ====== Render filas ======
    const rel = iso => {
      if (!iso) return '‚Äî';
      const d = new Date(iso), now = new Date();
      const ms = d - now;
      const min = Math.round(ms/60000);
      if (min > 0) return `en ${min} min`;
      if (min < 0) return `hace ${Math.abs(min)} min`;
      return 'ahora';
    };

    function itemRow(r, actions=true) {
      const isExpired = (r.status === 'expired') || (r.expiresAt && Date.parse(r.expiresAt) < Date.now() && r.status === 'pending');
      const badge =
        r.status === 'validated' ? `<span class="ml-2 rounded-full bg-green-100 text-green-800 px-2 py-0.5 text-[11px]">Validada</span>` :
        r.status === 'cancelled' ? `<span class="ml-2 rounded-full bg-rose-100 text-rose-800 px-2 py-0.5 text-[11px]">Cancelada</span>` :
        isExpired ? `<span class="ml-2 rounded-full bg-amber-100 text-amber-800 px-2 py-0.5 text-[11px]">Expirada</span>` :
        `<span class="ml-2 rounded-full bg-indigo-100 text-indigo-800 px-2 py-0.5 text-[11px]">Pendiente</span>`;

      const link = `/validar.html?code=${encodeURIComponent(r.code)}`;
      const tipo = r.mode === 'uyu2usd' ? `Venta $ ${fmt(r.sell)}` : `Compra $ ${fmt(r.buy)}`;
      const fee = (typeof r.feeUsd === 'number') ? ` ¬∑ Fee $ ${fmt(r.feeUsd)} USD` : '';

      return `
      <div class="py-3 flex items-center justify-between gap-4">
        <div class="min-w-0">
          <div class="font-mono font-semibold text-slate-900">${r.code}${badge}</div>
          <div class="text-sm text-slate-600 truncate">${r.sourceName || '‚Äî'} ‚Äî USD ${fmt(r.usdAmount)} ¬∑ UYU $ ${fmt(r.uyus)} ¬∑ ${tipo}${fee}</div>
          <div class="text-xs text-slate-500">Vence: ${r.expiresAt ? new Date(r.expiresAt).toLocaleString('es-UY') : '‚Äî'} ${r.expiresAt ? `(${rel(r.expiresAt)})` : ''}</div>
        </div>
        <div class="shrink-0 flex items-center gap-2">
          <a href="${link}" target="_blank" class="text-sm rounded-lg px-3 py-1.5 ring-1 ring-slate-200 hover:bg-slate-50">Abrir</a>
          ${actions && r.status==='pending' ? `
            <button data-act="validate" data-code="${r.code}" class="text-sm rounded-lg px-3 py-1.5 bg-brand-600 text-white hover:bg-brand-700">Validar</button>
            <button data-act="cancel" data-code="${r.code}" class="text-sm rounded-lg px-3 py-1.5 bg-rose-600 text-white hover:bg-rose-700">Cancelar</button>
          ` : ''}
        </div>
      </div>`;
    }

    // ====== C√°lculo de fees ======
    function startOfDay(d = new Date()) {
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x;
    }
    function sumFeesValidated(list, from, to) {
      const fromMs = from ? from.getTime() : -Infinity;
      const toMs   = to   ? to.getTime()   :  Infinity;

      let total = 0;
      for (const r of list) {
        if (r.status !== 'validated') continue;
        const fee = Number(r.feeUsd || 0);
        if (!fee) continue;

        // Usamos validatedAt; fallback a updatedAt/lockedAt/expiresAt si hiciera falta
        const when = asDate(r.validatedAt) || asDate(r.updatedAt) || asDate(r.lockedAt) || asDate(r.expiresAt);
        const t = when ? when.getTime() : 0;
        if (t >= fromMs && t < toMs) total += fee;
      }
      return total;
    }

    // ====== Carga principal ======
    async function loadAll() {
      const qEl = $('#q');
      const q = (qEl?.value || '').trim();
      const qs = q ? `?q=${encodeURIComponent(q)}` : '';
      let list = [];
      try {
        list = await API.list(qs);
      } catch (e) {
        console.error(e);
      }

      const now = new Date();
      const today0 = startOfDay(now);
      const yday0  = new Date(today0.getTime() - 24*60*60*1000);
      const d7     = new Date(today0.getTime() - 7 *24*60*60*1000);
      const d30    = new Date(today0.getTime() - 30*24*60*60*1000);

      const pending   = list.filter(r => r.status === 'pending');
      const validated = list.filter(r => r.status === 'validated');
      const expired   = list.filter(r => r.status === 'expired' || (r.expiresAt && Date.parse(r.expiresAt) < Date.now() && r.status==='pending'));
      const cancelled = list.filter(r => r.status === 'cancelled');

      // KPIs estado
      $('#kpi-pending').textContent   = pending.length;
      $('#kpi-validated').textContent = validated.filter(r => Date.parse(r.validatedAt||0) > (Date.now() - 24*60*60*1000)).length;
      $('#kpi-expired').textContent   = expired.length;
      $('#kpi-cancelled').textContent = cancelled.length;

      // KPIs Fees
      $('#fee-today').textContent     = fmt(sumFeesValidated(list, today0, now));
      $('#fee-yesterday').textContent = fmt(sumFeesValidated(list, yday0, today0));
      $('#fee-7d').textContent        = fmt(sumFeesValidated(list, d7, now));
      $('#fee-30d').textContent       = fmt(sumFeesValidated(list, d30, now));

      // Listas
      $('#list-pending').innerHTML = pending.length
        ? pending.map(r => itemRow(r, true)).join('')
        : '<div class="py-6 text-sm text-slate-500">No hay pendientes.</div>';

      // Ordenar validadas por fecha (recientes primero)
      validated.sort((a,b) => Date.parse(b.validatedAt||b.updatedAt||0) - Date.parse(a.validatedAt||a.updatedAt||0));
      $('#list-validated').innerHTML = validated.length
        ? validated.map(r => itemRow(r, false)).join('')
        : '<div class="py-6 text-sm text-slate-500">A√∫n sin operaciones validadas.</div>';

      $('#lastUpdated').textContent = new Date().toLocaleString('es-UY');

      // Acciones
      $$('#list-pending [data-act="validate"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const code = btn.dataset.code;
          const branch = prompt('Sucursal (opcional):', '');
          const by = prompt('Atendido por (tu nombre/alias):', '');
          await API.validate(code, { branch, by });
          await loadAll();
        });
      });
      $$('#list-pending [data-act="cancel"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const code = btn.dataset.code;
          const ok = confirm(`¬øCancelar la operaci√≥n ${code}?`);
          if (!ok) return;
          const note = prompt('Motivo de cancelaci√≥n (opcional):', '');
          await API.cancel(code, { note });
          await loadAll();
        });
      });
    }
  </script>
</body>
</html>
