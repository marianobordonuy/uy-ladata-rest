<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de Cambio ‚Äî uyu.exchange</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:'#f1f8f5',100:'#dcefe6',200:'#c1e1d1',300:'#99ccb3',400:'#6fb896',
              500:'#4aa87d',600:'#2f9467',700:'#247a56',800:'#1f6247',900:'#1a523c'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gradient-to-b from-white to-brand-50 text-slate-900 antialiased">

  <!-- Header consistente con el sitio -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/70 border-b border-slate-200">
    <div class="max-w-6xl mx-auto flex justify-between items-center px-4 py-3">
      <a href="/index.html" class="flex items-center gap-2 font-semibold">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-brand-600 text-white">U</span>
        <span class="hidden sm:inline">uyu.exchange</span>
      </a>
      <nav class="hidden sm:flex items-center gap-4 text-sm">
        <a href="/docs.html" class="hover:text-brand-700">üìÑ Docs</a>
        <a href="/index.html" class="hover:text-brand-700">üè† Inicio</a>
      </nav>
      <a href="/admin.html" class="ml-3 inline-flex items-center rounded-lg bg-brand-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-brand-700">
        ‚öôÔ∏è Admin
      </a>
    </div>
  </header>

  <!-- Contenido -->
  <main class="max-w-xl w-full mx-auto px-4 sm:px-6 mt-8 sm:mt-12">
    <div class="bg-white rounded-2xl shadow-xl ring-1 ring-brand-200 p-5 sm:p-7">
      <div class="text-center">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-brand-900">Calculadora de Cambio</h1>
        <p class="mt-1 text-sm sm:text-base text-brand-800">Basado en la <span class="font-semibold">media</span> de la fuente seleccionada</p>
        <div class="mt-3 inline-flex items-center gap-2 text-[12px] sm:text-xs text-brand-700 bg-brand-50 px-3 py-1.5 rounded-full">
          <span>üíµ Modo USD ‚Üí UYU</span>
          <span class="h-1 w-1 rounded-full bg-brand-300"></span>
          <span>Ideal para transferencias entre clientes</span>
        </div>
      </div>

      <!-- Selector de fuente -->
      <div class="mt-6">
        <label for="currency-source" class="block font-semibold mb-1 text-sm sm:text-base text-brand-900">Fuente</label>
        <select id="currency-source"
          class="w-full p-3 text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-400">
          <option value="itau">Ita√∫</option>
          <option value="bandes">Bandes</option>
          <!-- agreg√° m√°s si quer√©s -->
        </select>
      </div>

      <!-- Monto en USD -->
      <div class="mt-4">
        <label for="usd-amount" class="block font-semibold mb-1 text-sm sm:text-base text-brand-900">Monto en USD</label>
        <div class="relative">
          <input id="usd-amount" type="number" inputmode="decimal" min="1" value="100"
            class="w-full p-3 pr-20 text-lg border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-400" />
          <span class="absolute inset-y-0 right-3 flex items-center text-sm sm:text-base text-slate-500">USD</span>
        </div>
        <p class="mt-1 text-xs text-slate-500">Rango sugerido: 1 a 1.000.000 USD</p>
      </div>

      <!-- Bot√≥n calcular -->
      <button onclick="calcular()"
        class="mt-5 w-full inline-flex items-center justify-center gap-2 bg-brand-600 text-white text-base sm:text-lg py-3 rounded-xl hover:bg-brand-700 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9 .75.75 0 0 0-1.5 0 7.5 7.5 0 1 1-7.5-7.5.75.75 0 0 0 0-1.5Z"/><path d="M12 6.75a.75.75 0 0 0-.75.75v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-3.75H15a.75.75 0 0 0 0-1.5h-2.25V7.5A.75.75 0 0 0 12 6.75Z"/></svg>
        Calcular
      </button>

      <!-- Resultado -->
      <div id="result" class="mt-6 text-center text-base sm:text-lg"></div>

      <!-- Historial -->
      <section id="history" class="mt-6 border-t pt-4">
        <h2 class="font-semibold text-brand-900 mb-2">√öltimas 3 consultas</h2>
        <ul id="history-list" class="list-disc list-inside text-sm text-slate-700"></ul>
      </section>

      <!-- Acciones secundarias -->
      <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button onclick="compartirWhatsApp()" class="w-full bg-green-100 text-green-800 py-2.5 rounded-lg hover:bg-green-200">
          üì≤ Compartir WhatsApp
        </button>
        <button onclick="copiarResultado()" class="w-full bg-slate-100 text-slate-800 py-2.5 rounded-lg hover:bg-slate-200">
          üìã Copiar Resultado
        </button>
      </div>

      <!-- Volver -->
      <div class="mt-6">
        <a href="/index.html"
          class="block text-center bg-white ring-1 ring-brand-200 text-brand-800 py-2.5 rounded-lg hover:bg-brand-50 transition">
          ‚¨ÖÔ∏è Volver al Inicio
        </a>
      </div>

      <!-- Descargo -->
      <p class="mt-6 text-xs sm:text-sm text-slate-500 text-center border-t pt-4 leading-snug">
        ‚ö†Ô∏è <strong>Descargo:</strong> La informaci√≥n es meramente informativa.
        No nos hacemos responsables por decisiones financieras basadas en estos datos.
      </p>
    </div>
  </main>

  <!-- Footer m√≠nimo -->
  <footer class="mt-8 mb-6 text-center text-[11px] sm:text-xs text-slate-500">
    ¬© <span id="year"></span> uyu.exchange ‚Äî Hecho en Uruguay üá∫üáæ
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // TODO: mover esta key al backend o usar cookie/Storage seguro si es demo.
    const apikey = "admin123";
    let resultadoTexto = "";

    // Mostrar historial al cargar
    document.addEventListener('DOMContentLoaded', () => {
      mostrarHistorial();
    });

    function validarMonto(monto) {
      if (isNaN(monto) || monto <= 0) {
        toast('Por favor ingres√° un monto v√°lido mayor a 0.', 'error'); return false;
      }
      if (monto > 1000000) {
        toast('Ingres√° un monto menor a 1.000.000.', 'error'); return false;
      }
      return true;
    }

    // Mini toast
    function toast(msg, type='info'){
      const el = document.createElement('div');
      el.className = `fixed left-1/2 -translate-x-1/2 top-4 z-50 px-4 py-2 rounded-lg shadow
        ${type==='error' ? 'bg-red-600 text-white' : 'bg-brand-600 text-white'}`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 2200);
    }

    // Cache 3 minutos por fuente
    async function obtenerDatos(fuente) {
      const cacheKey = `cache_${fuente}`;
      const cache = JSON.parse(localStorage.getItem(cacheKey) || 'null');
      const now = Date.now(), ttl = 3 * 60 * 1000;

      if (cache && (now - cache.timestamp) < ttl) return cache.data;

      const res = await fetch(`/api/currency/${fuente}?apikey=${apikey}`);
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();

      localStorage.setItem(cacheKey, JSON.stringify({ timestamp: now, data }));
      return data;
    }

    async function calcular() {
      const montoUSD = parseFloat(document.getElementById("usd-amount").value);
      const fuente = document.getElementById("currency-source").value;
      const resultDiv = document.getElementById("result");

      if (!validarMonto(montoUSD)) {
        resultDiv.innerHTML = "";
        return;
      }

      resultDiv.innerHTML = `<div class="inline-flex items-center gap-2 text-slate-600">
        <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"/><path d="M4 12a8 8 0 018-8" stroke-width="4" class="opacity-75"/></svg>
        <span>Cargando‚Ä¶</span>
      </div>`;

      try {
        const data = await obtenerDatos(fuente);
        if (!data.media) { resultDiv.innerHTML = "No se pudo obtener la media."; return; }

        const pesosMedia = (montoUSD * data.media).toFixed(2);
        const pesosBuy   = (montoUSD * data.buy).toFixed(2);
        const beneficio  = (pesosMedia - pesosBuy).toFixed(2);
        const porcentaje = (((data.media - data.buy) / data.buy) * 100).toFixed(2);

        resultadoTexto = `${montoUSD} USD ‚Üí ${pesosMedia} UYU (Media ${fuente.charAt(0).toUpperCase()+fuente.slice(1)})`;

        resultDiv.innerHTML = `
          <div class="rounded-xl ring-1 ring-brand-200 bg-brand-50 p-4 text-left">
            <div class="flex items-center justify-between">
              <p class="text-base sm:text-lg">Media actual</p>
              <span class="inline-flex items-center rounded-full bg-brand-600 text-white px-2 py-0.5 text-[11px]">Preferencial</span>
            </div>
            <p class="mt-1 text-xl sm:text-2xl font-extrabold text-brand-900">${data.media.toFixed(2)} UYU</p>

            <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div class="rounded-lg bg-white ring-1 ring-brand-200 p-3">
                <div class="text-xs text-slate-500">Monto</div>
                <div class="text-lg font-semibold">${montoUSD} USD</div>
              </div>
              <div class="rounded-lg bg-white ring-1 ring-brand-200 p-3">
                <div class="text-xs text-slate-500">Resultado</div>
                <div class="text-lg font-semibold">${pesosMedia} UYU</div>
              </div>
              <div class="rounded-lg bg-white ring-1 ring-brand-200 p-3">
                <div class="text-xs text-slate-500">Compra/Venta</div>
                <div class="text-sm"><span class="font-medium">C:</span> ${data.buy} &nbsp;|&nbsp; <span class="font-medium">V:</span> ${data.sell}</div>
              </div>
            </div>

            <p class="mt-3 text-green-700 font-semibold">
              üí∞ Beneficio estimado: ${beneficio} UYU
              <span class="text-xs text-green-800">(${porcentaje}% vs compra normal)</span>
            </p>

            <p class="mt-1 text-[12px] text-slate-500">√öltima actualizaci√≥n: ${new Date(data.timestamp).toLocaleString()}</p>
          </div>
        `;

        guardarEnHistorial({
          fecha: new Date().toISOString(),
          montoUSD,
          fuente,
          resultado: resultadoTexto
        });
        mostrarHistorial();

      } catch (err) {
        resultDiv.innerHTML = `<span class="text-red-600">Error al obtener datos.</span>`;
      }
    }

    function guardarEnHistorial(consulta) {
      let historial = JSON.parse(localStorage.getItem('calculadoraHistorial') || '[]');
      historial.unshift(consulta);
      if (historial.length > 3) historial.pop();
      localStorage.setItem('calculadoraHistorial', JSON.stringify(historial));
    }

    function mostrarHistorial() {
      const historial = JSON.parse(localStorage.getItem('calculadoraHistorial') || '[]');
      const ul = document.getElementById('history-list');
      if (!ul) return;

      if (historial.length === 0) {
        ul.innerHTML = '<li class="text-slate-500">No hay consultas recientes.</li>';
        return;
      }

      ul.innerHTML = historial.map(c => {
        const fecha = new Date(c.fecha).toLocaleString();
        return `<li class="mb-1"><strong>${c.montoUSD} USD</strong> con <em>${c.fuente.charAt(0).toUpperCase()+c.fuente.slice(1)}</em> ‚Äî ${c.resultado}<br><span class="text-[11px] text-slate-400">${fecha}</span></li>`;
      }).join('');
    }

    function compartirWhatsApp() {
      if (!resultadoTexto) { toast('Calcul√° primero', 'error'); return; }
      const url = `https://wa.me/?text=${encodeURIComponent(resultadoTexto)}`;
      window.open(url, "_blank");
    }

    function copiarResultado() {
      if (!resultadoTexto) { toast('Nada para copiar', 'error'); return; }
      navigator.clipboard.writeText(resultadoTexto);
      toast('Resultado copiado ‚úÖ');
    }
  </script>
</body>
</html>
